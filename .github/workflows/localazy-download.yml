name: 🌐 Download Localazy translations

on:
  workflow_dispatch: # This allows the workflow to be triggered manually

jobs:
  localazy-download-test:
    name: Download translations and create PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Download translations from Localazy
        uses: localazy/download@v1
        with:
          read_key: ${{ secrets.LOCALAZY_READ_KEY }}
          write_key: ${{ secrets.LOCALAZY_WRITE_KEY }}

      - name: Generate branch name
        id: branch-name
        run: echo "BRANCH_NAME=translation-update-$(date --utc +%Y-%m-%dT%H-%M-%S)" >> $GITHUB_ENV

      - name: Create and checkout new branch
        run: |
          git checkout -b ${{ env.BRANCH_NAME }}

      - name: Commit changes to branch
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Action"
          git add public/locales/
          git commit -m "Update translation files" -a || echo "No changes to commit"

      - name: Push changes and create a pull request
        uses: peter-evans/create-pull-request@v3
        with:
          branch: ${{ env.BRANCH_NAME }}
          commit-message: Update translation files
          title: '[AUTO] Update translation files'
          body: 'Automated pull request to update translation files by pulling them from Localazy.'
          delete-branch: true
          base: main
          assignees: ${{ github.actor }}
